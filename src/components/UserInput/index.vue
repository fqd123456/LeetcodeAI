<template>
  <div class="h-52 bg-green-50 px-2">
    <div class="flex items-center relative flex-col w-full">
      <!-- <div class="w-full"> -->
        <textarea type="text" noresize
          @keydown.enter.prevent="sendMessage"
          v-model="userInput"
          class="w-full h-28 text-base box-border pb-20 rounded-xl bg-transparent border-2 border-blue-400 p-1"
          placeholder="Please enter your question"
          :maxlength="3000">
        </textarea>
        
        <!-- 在textarea下方添加插槽内容的容器 -->
        <div class="absolute bottom-0 left-0 right-0 px-2 py-0.5 flex justify-between">
          <div class="flex items-center">  <!-- 使用 flex 和 justify-between 创建水平布局 -->
            <PlanInfo :free_times="free_times" :user="user" />
            <label class="rounded-xl text-white p-1 px-2 ml-1 flex items-center" for="file-upload">
              <!-- 图片上传图标 -->
              <svg t="1727690636991" class="icon cursor-pointer" viewBox="0 0 1024 1024" version="1.1"
                xmlns="http://www.w3.org/2000/svg"
                p-id="7503" width="10" height="10">
                <path
                  d="M514.2528 916.1728c-98.9696 0-198.7072-0.0512-298.6496-0.1536-91.8528-0.1024-138.496-46.592-138.5984-138.1376-0.2048-179.0976-0.2048-358.6048 0-533.4528 0.1024-89.856 48.0256-137.472 138.5984-137.6256 69.5296-0.1024 139.0592-0.1024 208.5888-0.0512h178.8416c69.5296-0.0512 139.1104-0.0512 208.64 0.0512 88.4736 0.1536 137.216 48.5888 137.2672 136.2944 0.0512 178.688 0.0512 357.4272 0 536.1152-0.0512 88.064-48.7936 136.6528-137.3184 136.7552-97.8432 0.1536-197.2224 0.2048-297.3696 0.2048zM334.7968 168.192c-39.68 0-79.36 0-119.04 0.1024-57.0368 0.0512-77.2096 20.0192-77.312 76.1856-0.2048 174.7968-0.2048 354.2528 0 533.2992 0.0512 57.2928 19.5584 76.6976 77.2096 76.7488 200.96 0.2048 401.4592 0.2048 595.8656 0 54.6304-0.0512 75.9296-21.1968 75.9808-75.3152 0.0512-178.688 0.0512-357.376 0-536.064 0-54.4768-20.5824-74.8032-75.9296-74.9056-69.4784-0.1024-139.008-0.1024-208.4864-0.0512h-268.288z"
                  fill="#707070" p-id="7504"></path>
                <path
                  d="M326.3488 439.1936c-55.8592 0-101.3248-45.4656-101.3248-101.3248S270.4896 236.544 326.3488 236.544s101.3248 45.4656 101.3248 101.3248-45.4144 101.3248-101.3248 101.3248z m0-141.1584c-21.9648 0-39.8848 17.8688-39.8848 39.8848 0 21.9648 17.8688 39.8848 39.8848 39.8848s39.8848-17.8688 39.8848-39.8848-17.8688-39.8848-39.8848-39.8848zM769.1776 769.28H257.7408a44.9536 44.9536 0 0 1-40.4992-25.088c-7.68-15.4624-6.0416-33.6384 4.4032-47.4112 29.6448-39.2704 88.7808-117.6576 113.3568-150.272a45.03552 45.03552 0 0 1 35.0208-18.0224 44.9536 44.9536 0 0 1 35.8912 16.3328c15.9744 19.2512 45.0048 54.016 65.792 78.8992 30.976-39.5776 84.3776-107.8272 107.6736-137.7792 8.704-11.2128 21.7088-17.5616 36.0448-17.4592 14.1824 0.1024 27.1872 6.656 35.7376 17.92 31.6928 41.9328 118.7328 161.536 154.6752 211.0464 10.0352 13.824 11.4688 31.8976 3.6864 47.1552a45.14816 45.14816 0 0 1-40.3456 24.6784z"
                  fill="#707070" p-id="7505"></path>
              </svg>
              <span class="text-gray-500">image</span>
            </label>
            <input id="file-upload" @change="uploadFile" accept="image/png,image/jpeg,image/jpg,image/webp"
              name="file-upload" type="file" class="hidden" />
            
          </div>
          <button class="rounded-xl bg-blue-400 my-1 text-white p-1 px-5" 
            :disabled="!userInput.trim()" 
            :class="{ 'opacity-50 cursor-not-allowed': !userInput.trim() }"
            @click="sendMessage">
            Send
          </button>
          
        </div>

    </div>
  </div>
</template>

<style scoped>
textarea {
  resize: none;
}

/* 确保输入框有足够的底部padding来容纳插槽内容 */
.textarea {
  padding-bottom: 80px; /* 根据实际内容高度调整 */
}
</style>

<script setup>
import { ref, defineProps, defineEmits } from 'vue'
import PlanInfo from '../PlanInfo.vue'
import Screenshot from './Screenshot.vue'
const userInput = ref('')
import { message, Modal } from 'ant-design-vue';

const props = defineProps(['free_times', 'user'])
const emits = defineEmits(['sendMessage'])
const sendMessage = () => {
  const is_subscribed = props.user?.subscription?.is_subscribed;
  const free_times = props.free_times;
  if (free_times <= 0 && !is_subscribed) {
    Modal.confirm({
      title: 'Free Plan Limit Reached',
      content: 'Please upgrade to a pro plan before proceeding.',
      okText: 'Upgrade',
      cancelText: 'Cancel',
      onOk () {
        upgrade();
      },
      onCancel () { },
    });
    return
  }

  if (userInput.value.trim()) {
    emits('sendMessage', userInput.value, null)
    userInput.value = ''
  } else {
    message.warning("Please enter question")
  }
}

const sendImgMessage = (img_url) => {
  const is_subscribed = props.user?.subscription?.is_subscribed;
  const free_times = props.free_times;
  if (free_times <= 0 && !is_subscribed) {
    Modal.confirm({
      title: 'Free Plan Limit Reached',
      content: 'Please upgrade to a pro plan before proceeding.',
      okText: 'Upgrade',
      cancelText: 'Cancel',
      onOk () {
        upgrade();
      },
      onCancel () { },
    });
    return
  }
  emits('sendMessage', null, img_url)
}


const uploadFile = (e) => {

  const is_subscribed = props.user?.subscription?.is_subscribed;
  const free_times = props.free_times;
  if (free_times <= 0 && !is_subscribed) {
    Modal.confirm({
      title: 'Free Plan Limit Reached',
      content: 'Please upgrade to a pro plan before proceeding.',
      okText: 'Upgrade',
      cancelText: 'Cancel',
      onOk () {
        upgrade();
      },
      onCancel () { },
    });
    return
  }

  console.log(e)
  //拦截非图片
  const file = e.target.files[0]
  if (!file.type.startsWith('image/')) {
    message.warning('Please upload image')
    return
  }

  // 获取图片base64
  const reader = new FileReader()
  reader.readAsDataURL(file)
  reader.onload = () => {
    console.log(reader.result)
    emits('sendMessage', null, reader.result)
  }
}

const upgrade = () => {
  chrome.runtime.sendMessage({
    msg: 'subscribed'
  })
}


chrome.runtime.onMessage.addListener(function (request, sender, sendResponse) {
    console.log(request, 'request');
    if(request.msg==='searchImg'){
      sendImgMessage(request.data)
    }else if(request.msg==='searchText'){
      userInput.value = request.data
      sendMessage()
    }else if(request.msg==='screenshot'){
      chrome.tabs.sendMessage(tabs[0].id, { type: 'screenshot',new_tab:true });
    }
});



</script>

<style scoped>
textarea {
  resize: none;
}
</style>