console.log("background.js");var u=!1;function v(){u=chrome.sidePanel!=null,u?(chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(e=>console.error(e)),chrome.tabs.onActivated.addListener(async({tabId:e})=>{chrome.storage.sync.get({displayMode:"sidePanel"},t=>{h(e,t.displayMode)})})):(chrome.action.setPopup({popup:"popup.html"}),chrome.sidePanel&&chrome.sidePanel.setOptions({enabled:!1})),chrome.tabs.query({active:!0,currentWindow:!0},function(e){try{"vivExtData"in e[0]&&(u=!1,h(e[0].id,"popup"))}catch{}})}function h(e,r){var r=r;u||(r="popup"),chrome.storage.sync.set({displayMode:r}),r=="sidePanel"?(chrome.action.setPopup({popup:""}),chrome.sidePanel.setOptions({tabId:e,path:"src/pages/popup/index.html",enabled:!0})):(chrome.action.setPopup({popup:"popup.html"}),chrome.sidePanel&&chrome.sidePanel.setOptions({tabId:e,enabled:!1}))}chrome.runtime.onInstalled.addListener(async e=>{e.reason===chrome.runtime.OnInstalledReason.INSTALL||(e.reason,chrome.runtime.OnInstalledReason.UPDATE),chrome.runtime.setUninstallURL("https://www.livepolls.app/chrome_addons?type=uninstall&from=ai_homeworker")});chrome.runtime.onMessage.addListener(function(e,t,r){if(console.log(e,"message"),e.msg==="changeDisplayMode")return h(e.tabId,e.displayMode),setTimeout(function(){r()},100),!0;if(e.type=="getBase64")return chrome.tabs.query({active:!0,currentWindow:!0},function(n){const o=n[0];chrome.tabs.captureVisibleTab(c=>{console.log("发送了截屏数据",c),chrome.tabs.sendMessage(o.id,{type:"base64",data:c})})}),!0;if(e.msg=="get_user"){console.log("get_user");const n=(e==null?void 0:e.byStorage)||!1;return m(n).then(async o=>{let c=await chrome.storage.sync.get(["usetime"]),i=Math.max(0,3-((c==null?void 0:c.usetime)||0));console.log({user:o.user===!1?!1:o,jwt:o==null?void 0:o.jwt,free_times:i}),r({user:o.user===!1?!1:o,jwt:o==null?void 0:o.jwt,free_times:i})}),!0}else if(e.msg==="login")M(e.data);else if(e.msg=="subscribed")T();else{if(e.msg==="canDisplayInSidePanel")return r(u),!0;if(e.msg==="useFreeTimes")return I(),!0;if(e.msg==="new_tab_search_img")return chrome.tabs.create({url:"src/pages/popup/index.html"},n=>{setTimeout(()=>{chrome.tabs.sendMessage(n.id,{msg:"searchImg",data:e.base64})},1e3)}),!0;if(e.msg==="open_side_panel")return chrome.sidePanel.open({tabId:t.tab.id}),chrome.sidePanel.setOptions({tabId:t.tab.id,path:"index.html",enabled:!0}),!1}});chrome.contextMenus.create({contexts:["image"],id:"img",title:"Get Answer"});chrome.contextMenus.create({contexts:["selection"],id:"text",title:"Get Answer"});chrome.contextMenus.create({contexts:["page"],id:"captrue",title:"Capture Question ➡️ Get Answer"});chrome.contextMenus.onClicked.addListener(async(e,t)=>(console.log(e,"info"),console.log(t,"tab"),e.menuItemId==="img"?chrome.tabs.create({url:"src/pages/popup/index.html"},r=>{setTimeout(()=>{chrome.tabs.sendMessage(r.id,{msg:"searchImg",data:e.srcUrl})},1e3)}):e.menuItemId==="text"?chrome.tabs.create({url:"src/pages/popup/index.html"},r=>{setTimeout(()=>{chrome.tabs.sendMessage(r.id,{msg:"searchText",data:e.selectionText})},1e3)}):e.menuItemId==="captrue"&&(console.log("捕获菜单项被点击"),chrome.tabs.sendMessage(t.id,{type:"screenshot",new_tab:!0})),!0));v();function P(){return new Promise(async(e,t)=>{let r=await chrome.storage.sync.get(["g_user_info"]);r.g_user_info?e(r.g_user_info):chrome.identity.getProfileUserInfo({accountStatus:"ANY"},n=>{console.log("userInfo",n),e(n),chrome.storage.sync.set({g_user_info:n})})})}async function m(e){var c;if(e){let i=await chrome.storage.sync.get(["user","getUserDateNow"]);const p=i==null?void 0:i.user,s=i==null?void 0:i.getUserDateNow;if(s&&Date.now()-s<9*60*60*1e3&&p)return p;console.log("fetch user")}let t=await P(),r=t.id;const n={Referer:"https://www.livepolls.app/ai_homework_helper/chrome","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},o=await x({url:`https://www.livepolls.app/ai_homework_helper/api/user/status?email=${t==null?void 0:t.email}`,method:"POST",headers:n,data:{email:t==null?void 0:t.email,app_type:"chrome_addon",uuid:r}});return(c=o==null?void 0:o.subscription)!=null&&c.detail&&(o.subscription.is_subscribed=!0),chrome.storage.sync.set({jwt:o.jwt,user:o!=null&&o.profile?o:!1,getUserDateNow:Date.now()}),console.log("发送登录成功"),chrome.runtime.sendMessage({type:"loginSuccess",user:o!=null&&o.profile?o:!1,free_times:-1}),o}let a=null,f=1,g=1,d=!1;var w=!1;function T(){const t=`https://www.livepolls.app/ai_homework_helper/pricing?close=1&from=${navigator.userAgent.toLowerCase().match(/edg/)!=null?"edge_addon":"chrome_addon"}`;chrome.tabs.create({url:t},function(r){w=!0;function n(o,c){o===r.id&&(console.log("订阅页关闭"),m(),w=!1,chrome.tabs.onRemoved.removeListener(n))}chrome.tabs.onRemoved.addListener(n)}),setTimeout(()=>{g=1,y()},5e3)}async function y(){if(w)try{d=m(),a=await d,console.log("user",a),(!a.subscription||!a.subscription.free_cnt)&&g<50?setTimeout(()=>{g++,y()},4e3):a.subscription&&a.subscription.free_cnt&&(chrome.storage.sync.set({user:a,getUserDateNow:Date.now()}),chrome.runtime.sendMessage({type:"loginSuccess",user:a,free_times:-1}))}catch{}}var b=!1;async function M(e=!1){let t=navigator.userAgent.toLowerCase().match(/edg/)!=null,r=e?`https://www.livepolls.app/ai_homework_helper/login?subscribe=1&from=${t?"edge_addon":"chrome_addon"}`:`https://www.livepolls.app/ai_homework_helper/login?close=1&from=${t?"edge_addon":"chrome_addon"}`;console.log("打开标签页"),chrome.tabs.create({url:r},function(n){b=!0;function o(c,i){c===n.id&&(console.log("登录页关闭"),m(),b=!1,chrome.tabs.onRemoved.removeListener(o))}chrome.tabs.onRemoved.addListener(o)}),setTimeout(()=>{f=1,_(e)},5e3)}async function _(e){if(b)try{d=m(),a=await d,console.log("user",a),!a.profile&&f<50?setTimeout(()=>{f++,_()},4e3):a.profile&&(chrome.storage.sync.set({user:a,getUserDateNow:Date.now()}),chrome.runtime.sendMessage({type:"loginSuccess",user:a,free_times:-1}),e&&y())}catch(t){console.log("loopLogin:error",t)}}function x({url:e,data:t=null,method:r="GET",headers:n=null}){try{var o=new AbortController,c=o.signal}catch{}let i={method:r,headers:{"X-Access-Channel":"ai_homework_helper"}};if(n&&(i.headers=Object.assign(i.headers,n),n["Content-Type"]&&n["Content-Type"].indexOf("application/x-www-form-urlencoded")!=-1&&t)){let s="";Object.keys(t).forEach(l=>{(t[l]||t[l]==0)&&(s+=`${l}=${t[l]}&`)}),t=s.slice(0,s.length-1)}t&&(typeof t=="string"?i.body=t:i.body=JSON.stringify(t)),c&&(i.signal=c);const p=()=>new Promise((s,l)=>{setTimeout(()=>{s(new Response("timeout",{status:504,statusText:"timeout"})),o&&o.abort()},6e4)});return Promise.race([p(),fetch(e,i).then(s=>s.json())]).then(s=>s.success==!0||s.ok===0||s.code==0?((s.message||s.message==0)&&(window.g_message=s.message),Promise.resolve(s.data)):s&&(s.image||s.result)?Promise.resolve(s):s.statusText=="timeout"?Promise.reject("The system is busy, please try again later"):Promise.reject(s.message||s.msg&&s||"failed, please check your network and try again")).catch(s=>Promise.reject(s))}function I(){console.log("updateFreeTimes--"),chrome.storage.sync.get(["usetime"],e=>{let t=e.usetime||0;t<3?(t=t+1,chrome.storage.sync.set({usetime:t}),chrome.runtime.sendMessage({type:"updateFreeTimes",free_times:3-t})):(console.log("免费次数已达到上限"),chrome.runtime.sendMessage({type:"updateFreeTimes",free_times:0}))})}
